<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <script src="./kanva.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #f0f0f0;
    }

    #container {
      margin: 100px auto;
      width: 800px;
      height: 600px;
      border: 1px solid green;
    }
  </style>
</head>

<body>
  <div id="container"></div>
</body>
<script>
  var json = {
    "parts": [
      {
        "name": "square",
        "points": [
          20, 20,
          20, -20,
          -20, -20,
          -20, 20,
          20, 20
        ],
        "num": 50
      },
      {
        "name": "rectangle",
        "points": [
          20, 10,
          20, -10,
          -20, -10,
          -20, 10,
          20, 10
        ],
        "num": 50
      },
      {
        "name": "echelo1",
        "points": [
          20, 20,
          40, -20,
          -40, -20,
          -20, 20,
          20, 20
        ],
        "num": 50
      },
      {
        "name": "echelo2",
        "points": [
          20, 20,
          20, -20,
          -40, -20,
          -20, 20,
          20, 20
        ],
        "num": 50
      }
    ]
  }

  var stageOptions = {
    container: 'container',
    width: 800,
    height: 600
  }
  var stage = new Konva.Stage({
      container: stageOptions.container,
      width: stageOptions.width,
      height: stageOptions.height
    });

  var layer = new Konva.Layer();

  function random(min, max) {
    return parseInt(Math.random() * (max - min) + 1) + min;
  }

  function offset(points) {
    var maxX = 0, maxY = 0, minX = 0, minY = 0;
    points.forEach(function(item, index) {
      if (index % 2 === 0) {
        maxX = Math.max(item, maxX);
        minX = Math.min(item, minX);
      } else {
        maxY = Math.max(item, maxY);
        minY = Math.min(item, minY);
      } 
    })
    var offsetX = [-minX, stageOptions.width - maxX];
    var offsetY = [-minY, stageOptions.height - maxY];
    return {
      offsetX:offsetX, 
      offsetY:offsetY
    };  
  }
  
  function checkCollision(group, shape, offset) {
    var times = 0;
    var calc = function(r1, r2) {
      var bol = (r2.x > r1.x + r1.width ||
          r2.x + r2.width < r1.x ||
          r2.y > r1.y + r1.height ||
          r2.y + r2.height < r1.y);
      if (bol) {
        times = 0;
        return true;
      } else {
        times++;
        if (times > 1000000) {
          return false;
        }
        var posX = offset.offsetX;
        var posY = offset.offsetY;
        var newX = random(posX[0], posX[1]);
        var newY = random(posY[0], posY[1]);
        shape.setAttrs({
          x: newX,
          y: newY,
        })
        calc(r1, r2);
      }
    }
    
   for(var i = 0;i < group.length;i++) {
     if (!calc(group[i], shape)){
       return false;
     };
     return true;
   }
      
  }

  function draw(data) {
    var group = new Konva.Group();
    data.forEach(function(item, index) {
    var points = item.points;
    var pos = offset(points);
    var posX = pos.offsetX;
    var posY = pos.offsetY;
    console.log(posX)
    var shape = new Konva.Line({
      x: random(posX[0], posX[1]),
      y: random(posY[0], posY[1]),
      points: points,
      fill: '#8498d1',
      stroke: '#617bb5',
      strokeWidth: 2,
      closed: true,
    });
    checkCollision(group,shape,pos) ? group.add(shape) : '';
    //console.log(shape.getClientRect())
   });
   console.log(group.children.length)
   stage.add(layer);
   layer.add(group);
   layer.draw();
   
  }


  draw(json.parts);
</script>

</html>